{
  "name": "cuoi ku",
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {
          "q": "subject:\"H√≥a ƒë∆°n\" has:attachment in:inbox -in:spam"
        },
        "options": {
          "dataPropertyAttachmentsPrefixName": "attachment_",
          "downloadAttachments": true
        }
      },
      "id": "cb701c11-e4ed-4012-9c79-529b3d31fe5d",
      "name": "Gmail Trigger",
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1,
      "position": [
        -1024,
        176
      ],
      "credentials": {
        "gmailOAuth2": {
          "id": "icTEVPpEBdo1D4dq",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "language": "JavaScript",
        "jsCode": "// === PH·∫¶N B·∫†N PH·∫¢I S·ª¨A ===\n// ƒêi·ªÅn ch√≠nh x√°c t√™n node Gmail Trigger c·ªßa b·∫°n v√†o ƒë√¢y\nconst gmailNodeName = \"Gmail Trigger\"; \n// === H·∫æT C·∫§U H√åNH ===\n\n// === S·ª¨A L·ªñI: D√πng items[0].json (v√¨ mode l√† \"All Items\") ===\n// L·∫•y d·ªØ li·ªáu t·ª´ Gemini (ƒë·∫ßu v√†o c·ªßa node n√†y)\nconst geminiOutput = items[0].json;\n// === H·∫æT S·ª¨A L·ªñI ===\n\n// L·∫•y d·ªØ li·ªáu t·ª´ Gmail (node ƒë·∫ßu ti√™n)\nconst gmailNodeObject = $(gmailNodeName);\nconst gmailItem = gmailNodeObject.all()[0];\n\n// 1. L·∫•y th√¥ng tin t·ª´ Gmail (t·ª´ node trigger)\nlet sender = \"N/A\"; // ƒê·ªïi t√™n bi·∫øn n√†y\nlet receivedDate = \"N/A\";\nlet filename = \"Kh√¥ng c√≥ file\";\n\n// === GI·ªÆ NGUY√äN THEO TIP: Gi·ªØ to√†n b·ªô object binary ===\n// L·∫•y binary t·ª´ input items (t·ª´ node tr∆∞·ªõc ƒë√≥) ho·∫∑c t·ª´ Gmail node\nlet originalBinaryObject = {};\n\n// Th·ª≠ l·∫•y binary t·ª´ input items tr∆∞·ªõc (t·ª´ Code in JavaScript node)\nif (items[0] && items[0].binary) {\n  originalBinaryObject = items[0].binary;\n  console.log('Binary found in input items');\n} else if (gmailItem && gmailItem.binary) {\n  originalBinaryObject = gmailItem.binary;\n  console.log('Binary found in Gmail node');\n} else {\n  console.warn('No binary found in input items or Gmail node');\n}\n// === H·∫æT ===\n\nif (gmailItem) {\n  // === S·ª¨A L·ªñI [object Object] ·ªû ƒê√ÇY ===\n  // L·∫•y \"name\" t·ª´ b√™n trong object \"from\"\n  try {\n    sender = gmailItem.json.from.value[0].name; // L·∫•y \"Ph√πng M·∫°nh D≈©ng\"\n  } catch (e) {\n    sender = gmailItem.json.from.text || \"Kh√¥ng r√µ\"; // Fallback\n  }\n  // === H·∫æT S·ª¨A L·ªñI ===\n\n  receivedDate = new Date(gmailItem.json.date).toLocaleString('vi-VN', { \n      timeZone: 'Asia/Ho_Chi_MinH' \n  });\n \n  // L·∫•y t√™n file t·ª´ object binary\n  const firstBinKey = Object.keys(originalBinaryObject)[0]; // (v√≠ d·ª•: 'attachment_0')\n  if(firstBinKey) {\n    filename = originalBinaryObject[firstBinKey].fileName || \"Kh√¥ng c√≥ file\";\n  }\n} else {\n  // B√°o l·ªói n·∫øu kh√¥ng t√¨m th·∫•y node Gmail\n  filename = \"L·ªói: Kh√¥ng t√¨m th·∫•y node '\" + gmailNodeName + \"'\";\n}\n\n// 2. L·∫•y th√¥ng tin t·ª´ Gemini\nlet vat = \"L·ªói AI\";\nlet nhaCungCap = \"L·ªói AI\";\nlet ngayXuatHoaDon = \"L·ªói AI\";\n\ntry {\n  const rawText = geminiOutput.candidates[0].content.parts[0].text;\n  const jsonStart = rawText.indexOf('{');\n  const jsonEnd = rawText.lastIndexOf('}');\n  const jsonString = rawText.substring(jsonStart, jsonEnd + 1);\n  const extractedData = JSON.parse(jsonString);\n\n  vat = extractedData[\"M√£ s·ªë thu·∫ø(VAT)\"] || extractedData[\"M√£ s·ªë thu·∫ø (VAT)\"] || extractedData[\"vat\"] || \"Kh√¥ng t√¨m th·∫•y\";\n  nhaCungCap = extractedData[\"T√™n nh√† cung c·∫•p\"] || extractedData[\"nha_cung_cap\"] || \"Kh√¥ng t√¨m th·∫•y\";\n  ngayXuatHoaDon = extractedData[\"Ng√†y xu·∫•t h√≥a ƒë∆°n\"] || extractedData[\"ngay_hoa_don\"] || \"Kh√¥ng t√¨m th·∫•y\";\n} catch (e) {\n  vat = e.message;\n}\n\n// 3. Chuy·ªÉn binary th√†nh base64 ƒë·ªÉ g·ª≠i qua HTTP Request v·ªõi jsonParameters: true\nlet fileDataBase64 = null;\nlet fileMimeType = null;\n\n// Debug: Ki·ªÉm tra binary object\nconsole.log('Binary object keys:', Object.keys(originalBinaryObject));\n\nconst binKey = Object.keys(originalBinaryObject)[0];\nif (binKey && originalBinaryObject[binKey]) {\n  const binData = originalBinaryObject[binKey];\n  console.log('Binary data found:', binKey, 'has data:', !!binData.data, 'mimeType:', binData.mimeType);\n  \n  // n8n binary object c√≥ .data l√† base64 string\n  if (binData.data) {\n    // Ki·ªÉm tra xem data c√≥ ph·∫£i l√† string kh√¥ng\n    if (typeof binData.data === 'string') {\n      fileDataBase64 = binData.data; // ƒê√£ l√† base64 string\n      fileMimeType = binData.mimeType || binData.mime || 'application/octet-stream';\n      console.log('File data extracted, length:', fileDataBase64.length);\n    } else {\n      console.error('Binary data is not a string:', typeof binData.data);\n    }\n  } else {\n    console.warn('Binary data has no .data field');\n  }\n} else {\n  console.warn('No binary key found or binary object is empty');\n}\n\n// 4. K·∫øt h·ª£p t·∫•t c·∫£ l·∫°i (bao g·ªìm binary d∆∞·ªõi d·∫°ng base64)\nconst finalJson = {\n  nguoiGuiMail: sender, // Bi·∫øn \"sender\" b√¢y gi·ªù l√† \"Ph√πng M·∫°nh D≈©ng\"\n  ngayNhanMail: receivedDate,\n  tenFile: filename,\n  vat: vat,\n  nhaCungCap: nhaCungCap,\n  ngayXuatHoaDon: ngayXuatHoaDon,\n  // Th√™m binary d∆∞·ªõi d·∫°ng base64 ƒë·ªÉ HTTP Request node c√≥ th·ªÉ g·ª≠i\n  fileData: fileDataBase64, // Base64 string c·ªßa file\n  fileMimeType: fileMimeType,\n  // Gi·ªØ binary object cho c√°c node kh√°c (Google Drive, Telegram)\n  binary: originalBinaryObject\n};\n\n// 5. Tr·∫£ v·ªÅ JSON ƒë√£ k·∫øt h·ª£p V√Ä object binary G·ªêC (cho c√°c node kh√°c)\nreturn [{\n  json: finalJson,\n  binary: originalBinaryObject // Tr·∫£ v·ªÅ { attachment_0: {...} } cho Google Drive, Telegram\n}];"
      },
      "id": "c4ec7f53-61c6-4db3-8942-34293da0f376",
      "name": "Code Node",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        -288,
        192
      ]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "operation": "append",
        "sheetId": "1_J8iR9cBzQULddwnogXklPRe6Ka72r4wyX745iunEMU",
        "range": "A:Z",
        "options": {
          "valueInputMode": "RAW"
        }
      },
      "id": "06d1b9fb-fe83-4cb5-a21f-1b8bf8e60f26",
      "name": "Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "retryOnFail": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "foHPeTlyxgr0kMNZ",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "7060216856",
        "binaryData": true,
        "binaryPropertyName": "attachment_0",
        "additionalFields": {
          "caption": "=üîî H√ìA ƒê∆†N M·ªöI\n--------------------\nüìÅ T√™n file: {{$json.tenFile}}\nüìß Ng∆∞·ªùi g·ª≠i: {{$json.nguoiGuiMail}}\nüóìÔ∏è Ng√†y nh·∫≠n: {{$json.ngayNhanMail}}\n---\nVAT: {{$json.vat}}\nNh√† Cung C·∫•p: {{$json.nhaCungCap}}\nNg√†y Hƒê: {{$json.ngayXuatHoaDon}}"
        }
      },
      "id": "6069466d-9f8d-4ead-a549-b9237189c88f",
      "name": "Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        0,
        144
      ],
      "webhookId": "1f06a9a7-6612-4cc5-a75a-7c10b3227c6c",
      "credentials": {
        "telegramApi": {
          "id": "4Bl4VX3973bSgZVt",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "binaryData": true,
        "binaryPropertyName": "attachment_0",
        "name": "={{$json.tenFile}}",
        "parents": [
          "18nxWd1nQuls8ZGOoNJPgW0YH5HhPrfh3"
        ],
        "options": {}
      },
      "id": "5124ec64-4778-47dc-b355-84b70babdab1",
      "name": "Google Drive Upload",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 1,
      "position": [
        0,
        304
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "izxk8zUDyMFRdOd6",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "authentication": "basicAuth",
        "url": "https://improvable-nonconductible-honey.ngrok-free.dev/api/vat/webhook",
        "jsonParameters": true,
        "options": {},
        "bodyParametersJson": "={\n  \"tenFile\": \"{{$json.tenFile}}\",\n  \"nguoiGuiMail\": \"{{$json.nguoiGuiMail}}\",\n  \"ngayNhanMail\": \"{{$json.ngayNhanMail}}\",\n  \"vat\": \"{{$json.vat}}\",\n  \"nhaCungCap\": \"{{$json.nhaCungCap}}\",\n  \"ngayXuatHoaDon\": \"{{$json.ngayXuatHoaDon}}\",\n  \"fileData\": \"{{$json.fileData}}\",\n  \"fileMimeType\": \"{{$json.fileMimeType}}\"\n}"
      },
      "id": "b3161265-2e14-42a6-83b0-46172fce884f",
      "name": "HTTP Webhook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        0,
        448
      ],
      "credentials": {
        "httpBasicAuth": {
          "id": "hTS8NBSfINxmGIpp",
          "name": "Unnamed credential"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// L·∫•y item hi·ªán t·∫°i\nconst item = $input?.item ?? $item;\n\n// L·∫•y property binary h·ª£p l·ªá (∆∞u ti√™n 'data' r·ªìi 'attachments_0', sau ƒë√≥ auto-pick)\nconst bin = item.binary ?? {};\nconst propName = bin.data\n  ? 'data'\n  : (bin.attachments_0 ? 'attachments_0' : Object.keys(bin)[0]);\n\nif (!propName || !bin[propName]?.data) {\n  throw new Error(\"Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu file. H√£y b·∫≠t 'Download Attachments' tr√™n Gmail Trigger v√† ki·ªÉm tra t√™n binary property.\");\n}\n\n// ƒê·ªëi t∆∞·ª£ng binary c·ªßa n8n ƒë√£ l√† base64 ·ªü field .data\nconst b = bin[propName]; // { data: <base64>, mimeType, fileName }\n\nitem.json.data_base64 = b.data;                           // base64 s·∫µn\nitem.json.mime_type   = b.mimeType || 'application/octet-stream';\nitem.json.file_name   = b.fileName || 'attachment';\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -704,
        144
      ],
      "id": "c3d4d9f1-ac8b-4bcf-977a-50579c877629",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=AIzaSyC7Fu9Wlfr4dPLmX-pQ50FFCQPnBq7ishw",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [\n    {\n      \"parts\": [\n        {\n          \"text\": \"B·∫°n l√† m·ªôt tr·ª£ l√Ω k·∫ø to√°n. H√£y nh√¨n v√†o file h√≥a ƒë∆°n n√†y v√† tr√≠ch xu·∫•t: M√£ s·ªë thu·∫ø (VAT), T√™n nh√† cung c·∫•p, Ng√†y xu·∫•t h√≥a ƒë∆°n. Tr·∫£ l·ªùi CH·ªà d∆∞·ªõi d·∫°ng JSON.\"\n        },\n        {\n          \"inlineData\": {\n            \"mimeType\": \"{{ $json.mime_type }}\",\n            \"data\": \"{{ $json.data_base64 }}\"\n          }\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -480,
        144
      ],
      "id": "a282c879-3143-4ab5-a565-3a58125789df",
      "name": "HTTP Request"
    }
  ],
  "pinData": {},
  "connections": {
    "Gmail Trigger": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Node": {
      "main": [
        [
          {
            "node": "Google Drive Upload",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram",
            "type": "main",
            "index": 0
          },
          {
            "node": "Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Code Node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a8689116-f1b6-4563-913d-2d105df1e220",
  "meta": {
    "instanceId": "744faee57bbff3710af0cf3493f5a19d804affb1db608dbe7367ae05da513573"
  },
  "id": "IHji3Dr7D25fevnX",
  "tags": []
}